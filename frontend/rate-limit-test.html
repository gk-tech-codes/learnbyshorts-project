<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.googleapis.com https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https:; connect-src 'self' https://www.google-analytics.com;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">
    
    <title>Rate Limiting Test - LearnByShorts</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .pass { background: #d4edda; border-color: #c3e6cb; }
        .fail { background: #f8d7da; border-color: #f5c6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        button { background: #007bff; color: white; padding: 10px 15px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .status { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 3px; font-family: monospace; }
        .counter { font-size: 18px; font-weight: bold; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üîí Rate Limiting & Abuse Prevention Test</h1>
    
    <div class="test">
        <h3>üìä Current Rate Limit Status</h3>
        <div id="statusDisplay" class="status">Loading...</div>
        <button onclick="updateStatus()">Refresh Status</button>
        <button onclick="resetRateLimits()">Reset All Limits</button>
    </div>
    
    <div class="test">
        <h3>üß™ Test Form Submissions (Limit: 5 per 5 minutes)</h3>
        <div class="counter">Submissions: <span id="formCounter">0</span></div>
        <form id="testForm">
            <input type="text" placeholder="Test input" required>
            <button type="submit">Submit Form</button>
        </form>
    </div>
    
    <div class="test">
        <h3>üß™ Test API Calls (Limit: 50 per minute)</h3>
        <div class="counter">API Calls: <span id="apiCounter">0</span></div>
        <button onclick="testAPICall()">Make API Call</button>
        <button onclick="spamAPICall()">Spam API Calls (10x)</button>
    </div>
    
    <div class="test">
        <h3>üß™ Test Page Views (Limit: 100 per minute)</h3>
        <div class="counter">Page Views: <span id="pageCounter">1</span></div>
        <button onclick="simulatePageView()">Simulate Page View</button>
        <button onclick="spamPageViews()">Spam Page Views (20x)</button>
    </div>
    
    <div class="test">
        <h3>üõ°Ô∏è Rate Limiting Features:</h3>
        <ul>
            <li>‚úÖ <strong>Client Fingerprinting:</strong> Tracks users without cookies</li>
            <li>‚úÖ <strong>Multiple Limits:</strong> Different limits for different actions</li>
            <li>‚úÖ <strong>Visual Warnings:</strong> User-friendly rate limit notifications</li>
            <li>‚úÖ <strong>Automatic Cleanup:</strong> Removes old tracking data</li>
            <li>‚úÖ <strong>Fetch/XHR Protection:</strong> Intercepts all API calls</li>
        </ul>
    </div>

    <script src="js/rate-limiter.js"></script>
    <script>
        let formSubmissions = 0;
        let apiCalls = 0;
        let pageViews = 1;

        // Update status display
        function updateStatus() {
            const status = getRateLimitStatus();
            const statusDiv = document.getElementById('statusDisplay');
            
            let html = '';
            Object.keys(status).forEach(action => {
                const s = status[action];
                const percentage = (s.current / s.max * 100).toFixed(1);
                html += `<div><strong>${action}:</strong> ${s.current}/${s.max} (${percentage}%) - ${s.remaining} remaining</div>`;
            });
            
            statusDiv.innerHTML = html;
        }

        // Test form submission
        document.getElementById('testForm').addEventListener('submit', (e) => {
            e.preventDefault();
            formSubmissions++;
            document.getElementById('formCounter').textContent = formSubmissions;
            updateStatus();
        });

        // Test API call
        function testAPICall() {
            fetch('/data/courses.json')
                .then(() => {
                    apiCalls++;
                    document.getElementById('apiCounter').textContent = apiCalls;
                    console.log('‚úÖ API call successful');
                })
                .catch((error) => {
                    console.log('‚ùå API call blocked:', error.message);
                })
                .finally(() => {
                    updateStatus();
                });
        }

        // Spam API calls
        function spamAPICall() {
            for (let i = 0; i < 10; i++) {
                setTimeout(() => testAPICall(), i * 100);
            }
        }

        // Simulate page view
        function simulatePageView() {
            if (!window.rateLimiter.isRateLimited('pageViews')) {
                pageViews++;
                document.getElementById('pageCounter').textContent = pageViews;
                console.log('‚úÖ Page view tracked');
            } else {
                console.log('‚ùå Page view blocked');
            }
            updateStatus();
        }

        // Spam page views
        function spamPageViews() {
            for (let i = 0; i < 20; i++) {
                setTimeout(() => simulatePageView(), i * 50);
            }
        }

        // Reset rate limits
        function resetRateLimits() {
            window.resetRateLimits();
            formSubmissions = 0;
            apiCalls = 0;
            pageViews = 1;
            document.getElementById('formCounter').textContent = formSubmissions;
            document.getElementById('apiCounter').textContent = apiCalls;
            document.getElementById('pageCounter').textContent = pageViews;
            updateStatus();
        }

        // Initial status update
        updateStatus();
        
        // Auto-refresh status every 5 seconds
        setInterval(updateStatus, 5000);
    </script>
</body>
</html>
